{% extends 'cards/header.html' %}

{% block title %}Quiz: {{ flashcard_set.name }}{% endblock %}
{% block content %}
<div class="flashcard-nav-header">
    <div class="flashcard-nav-title">
        <h1>Quiz</h1>
    </div>
    <div class="flashcard-nav-buttons">
        <a href="{% url 'study' flashcard_set.id %}" class="loginbtn">Back</a>
    </div>
</div>

<div class="game-box">
    <form method="POST" action="{% url 'quiz_check' flashcard_set.id %}">
        {% csrf_token %}
        <h2><strong>Term:</strong> {{ flashcard.term }}</h2>
        <div class="definition-options">
            <p><strong>Choose the correct definition:</strong></p>
            {% for option in flashcard.options %}
                <div class="option">
                    <input type="radio" id="option{{ forloop.counter }}" name="selected_answer" value="{{ option }}" required>
                    <label for="option{{ forloop.counter }}" class="custom-radio">{{ option }}</label>
                </div>
            {% endfor %}
        </div>
        
        <input type="hidden" name="elapsed_time" id="elapsed_time" value="0">
        <input type="hidden" name="correct_answer" value="{{ flashcard.correct_answer }}">
        <button type="submit" class="check-button">Check</button>
    </form>

    <div id="feedback-bar" class="feedback-bar hidden">
        <p id="feedback-message"></p>
        <button id="next-button" class="next-button hidden">Next</button>
    </div>
</div>
<div class="progress-container">
    <div class="progress-bar" id="progress-bar"></div>
</div>
<div class="progress-info">
    <span id="progress-percentage">{{ progress_percentage|floatformat:0 }}%</span>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const startTime = Date.now();

        // Updates elapsed time in hidden input before form submission
        const form = document.querySelector('form');
        form.addEventListener('submit', () => {
            const elapsedTime = Math.round((Date.now() - startTime) / 1000);
            document.getElementById('elapsed_time').value = elapsedTime;
        });

        const percentage = parseFloat("{{ progress_percentage|default:0 }}");
        const progressBar = document.getElementById('progress-bar');
        progressBar.style.width = percentage + '%';

        // Handle session feedback
        const feedbackBar = document.getElementById('feedback-bar');
        const feedbackMessage = document.getElementById('feedback-message');
        const nextButton = document.getElementById('next-button');

        form.addEventListener('submit', async (event) => {
            event.preventDefault(); // Prevent the default form submission

            const formData = new FormData(form);
            const response = await fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                },
            });

            const data = await response.json();

            if (data.redirect) {
                window.location.href = data.url; // Redirect to the end page if necessary
            } else {
                feedbackMessage.textContent = data.feedback_message;
                feedbackBar.classList.remove('hidden');
                nextButton.classList.remove('hidden');
            }
        });

        nextButton.addEventListener('click', () => {
            feedbackBar.classList.add('hidden');
            nextButton.classList.add('hidden');
        });

        // Clear feedback from the session
        // fetch("{% url 'clear_feedback' %}", {
        //     method: 'POST',
        //     headers: { 'X-CSRFToken': '{{ csrf_token }}' },
        // });

        // Handle "Next" button click
        nextButton.addEventListener('click', () => {
            window.location.reload(); // Reloads the page to progress to the next question
        });
    });
</script>

<script id="feedback-data" type="application/json">
    {{ feedback_data|json_script:"feedback-data" }}
</script>
{% endblock %}
